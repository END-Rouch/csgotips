<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>CS:GO.Tips</title>
  <meta name="description" content="CSGO Nades">
  <meta name="author" content="Mingwei Samuel">
  
  <!-- Mobile Specific -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->

  <!--FAVICON-->
  <link rel="apple-touch-icon" sizes="57x57" href="favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
  <link rel="manifest" href="favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  <!--END FAVICON-->
  
  <link href='http://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='http://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css' rel='stylesheet' type='text/css'>
  <link href='./skeleton.custom.min.css' rel='stylesheet' type='text/css'>
  <style type="text/css">
    body {
      font-family: "Exo", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #000;
    }
    
    .top {
      padding-top: 2em;
    }
    
    p, h1, h2, h3, h4, h5, h6, span, select, button, input, li, table {
      -webkit-filter: invert(100%);
      -moz-filter: invert(100%);
      -ms-filter: invert(100%);
      -o-filter: invert(100%);
      filter: invert(100%);
    }
    
    .section {
      text-align: center;
    }

    .arrow {
      -webkit-transition: all 100ms ease 0s;
      -moz-transition: all 100ms ease 0s;
      -o-transition: all 100ms ease 0s;
      transition: all 100ms ease 0s;
    }
    
    #map, #callouts {
      -webkit-transition: opacity .5s ease 0s;
      -moz-transition: opacity .5s ease 0s;
      -ms-transition: opacity .5s ease 0s;
      -o-transition: opacity .5s ease 0s;
      transition: opacity .5s ease 0s;
    }
    #map.hide, #callouts.hide {
      opacity: 0;
    }

    .section.hide {
      display: none;
    }
    .thumb {
      background-size: cover;
      padding-top: 10%;
      padding-bottom: 10%;
      margin-bottom: 4%;
      cursor: pointer;
      opacity: 0.8666;
      color: #000;
    }
    .thumb:hover {
      opacity: 1.0;
      color: #222;
    }
  </style>
  
  <script type="text/javascript">
    if (location.href.indexOf('index.html') >= 0 && window.location.protocol !== "file:")
      location.replace(location.href.replace('index.html', '')); //remove 'index.html', no history entry
  </script>
  <script src="./snap.svg-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/js-signals/1.0.0/js-signals.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/hasher/1.2.0/hasher.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/crossroads/0.12.0/crossroads.min.js" type="text/javascript"></script>
</head>
<body>
  <div class="top section">
    <div class="container">
      <div class="row">
        <div class="twelve columns">
          <h1 style="cursor: pointer;" onclick="hasher.setHash('');">CS:GO.Tips</h1>
        </div>
      </div>
    </div>
  </div>
  <div id="popPage" class="hide section page" onclick="history.back();">
    <div class="container">
      <div class="row">
        <div id="gfyParent" class="nine columns">
          <!-- VIDEO HERE -->
        </div>
        <div class="three columns">
          <table class="u-full-width">
            <tbody>
              <tr>
                <td>From:</td>
                <td id="iFrom"></td>
              </tr>
              <tr>
                <td>To:</td>
                <td id="iTo"></td>
              </tr>
              <tr>
                <td>Team:</td>
                <td id="iTeam"></td>
              </tr>
              <tr>
                <td>Walk Speed:</td>
                <td id="iSpeed"></td>
              </tr>
              <tr>
                <td>Height:</td>
                <td id="iHeight"></td>
              </tr>
              <tr>
                <td>Throw Speed:</td>
                <td id="iThrow"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div id="mapPage" class="hide section page">
    <div class="container">
      <div class="row">
        <div class="nine columns">
          <svg id="map" class="hide">
            <!-- MAP -->
          </svg>
        </div>
        <div class="three columns">
          <div class="row">
            <select class="u-full-width" id="mapSelect" onchange="changeMap(this.value);">
              <!-- MAPS SELECT GOES HERE -->
            </select>
          </div>
          <div class="row">
            <select class="u-full-width" id="nadeSelect" onchange="changeGrenadeType(this.value);">
              <option value=''>None</option>
              <option value='all'>All</option>
              <option value='smokes'>Smoke</option>
              <option value='fires'>Molotov</option>
              <option value='flashes'>Flashbang</option>
            </select>
          </div>
          <div class="row">
            <input type="button" value="Show Callouts" id="toggleCallouts" class="u-full-width" onclick="toggleCallouts()" />
          </div>
          <div class="row">
            <h4>Throws:</h4>
            <ul id="nadeList">
              <!-- NADE LIST HERE -->
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="introPage" class="hide section page">
    <div class="container">
      <div id="thumbs" class="row">
        <div class="twelve columns">
          <p>Select A Map</p>
        </div>
      </div>
      <!-- THUMB CONTAINS > THUMBS -->
    </div>
  </div>
  <script type="text/javascript">

    window.onerror = function (message, file, line, column, errorObj) {
      if (errorObj !== undefined) //so it won't blow up in the rest of the browsers
        console.log('Error: ' + errorObj.stack);
    }
  
    var s = Snap("#map");
    var showCallouts = false;
    var maps = {};
    var delay = 500;
    
    (function() {
      var xmlhttp;
      if (window.XMLHttpRequest) // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
      else { // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        alert('Please stop using Internet Explorer 5/6 you fakkin joke');
      }
  
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
          if(xmlhttp.status == 200){
            maps = JSON.parse(xmlhttp.responseText);
            init();
          }
          else
            console.log('nade.json Error ' + xmlhttp.status);
        }
      };
  
      xmlhttp.open("GET", "./nades.json", true);
      xmlhttp.send();
    })();
    
    function init() {
      (function() { //update map lists
        var mapIds = Object.keys(maps);
        var row;
        for (var i = 0; i < mapIds.length; i++) {
          var map = maps[mapIds[i]];
          var opt = document.createElement('option')
          opt.setAttribute('value', mapIds[i]);
          opt.innerHTML = map.name;
          document.getElementById('mapSelect').appendChild(opt);

          if (i % 2 === 0) {
            row = document.createElement('div');
            row.classList.add('row');
            document.getElementById('thumbs').appendChild(row);
          }
          var thumb = document.createElement('div');
          thumb.className = 'thumb six columns';
          thumb.innerHTML = '<h4>' + map.name + '</h4>';
          thumb.style.backgroundImage = "linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('" + map.thumb + "')";
          thumb.onclick = function() {
            hasher.setHash(this, 'all');
          }.bind(mapIds[i]);
          row.appendChild(thumb);
        }
      })();

      function hideAll() {
        var pages = document.getElementsByClassName('page');
        for (var i = 0; i < pages.length; i++)
          pages[i].classList.add('hide');
      }

      function showMap(mapName, callback) {
        console.log('Showing map: ' + mapName)
        if (!maps.hasOwnProperty(mapName))
          return false;
        document.getElementById('gfyParent').innerHTML = ''; //clear video from memory

        var mapPage = document.getElementById('mapPage');
        if (mapPage.classList.contains('hide')) { // map is hidden if offsetParent === null, don't bother fading out
          hideAll();
          mapPage.classList.remove('hide');
          updateMap(mapName);
          if (callback)
            callback();
        }
        else {
          document.getElementById('map').classList.add('hide');
          setTimeout(function(mapName, callback) {
            updateMap(mapName);
            if (callback)
              callback();
          }, delay, mapName, callback);
        }
        return true;
      }

      function showVideo(mapName, nadeType, id) {
        console.log('Showing video');
        if (!maps.hasOwnProperty(mapName))
          return false;
        if (!maps[mapName].hasOwnProperty(nadeType))
          return false;
        if (!maps[mapName][nadeType].hasOwnProperty(id))
          return false;
        hideAll();
        document.getElementById('popPage').classList.remove('hide');
        updateVideo(maps[mapName][nadeType][id]);
        return true;
      }

      function revert() {
        console.log('Going back');
        setTimeout(function() {
          history.back();
        }, 0);
      }

      function setTitle(mapid) {
        document.title = 'CS:GO.Tips';
        if (mapid)
          document.title += ' - ' + maps[mapid].name;
      }

      crossroads.addRoute('', function() {
        hideAll();
        document.getElementById('introPage').classList.remove('hide');

        setTitle();
        document.getElementById('map').classList.add('hide'); //hide map
      });
      crossroads.addRoute('{mapName}', function(mapName) {
        console.log('MAP: ' + mapName);
        document.getElementById('nadeSelect').value = '';
        if (!showMap(mapName))
          revert();

        setTitle(mapName); //after revert
      });
      crossroads.addRoute('{mapName}/{nadeType}', function(mapName, nadeType) {
        console.log('MAP w/ NADES: ' + [mapName, nadeType]. join(', '));
        document.getElementById('nadeSelect').value = nadeType;
        if (!showMap(mapName, function() {
          if (nadeType === 'all') {
            updateMapNades(mapName, 'smokes');
            updateMapNades(mapName, 'fires');
            updateMapNades(mapName, 'flashes');
          }
          else if (!updateMapNades(mapName, nadeType))
            revert();
        }))
          revert();

        setTitle(mapName); //after revert
      });
      crossroads.addRoute('{mapName}/{nadeType}/{id}', function(mapName, nadeType, id) {
        console.log('VIDEO: ' + [mapName, nadeType, id].join(', '));
        setTitle(mapName);
        if (!showVideo(mapName, nadeType, id))
          revert();
      });

      var hashChange = function(newHash, oldHash) {
        crossroads.parse(newHash);
      };
      hasher.appendHash = '/';
      hasher.changed.add(hashChange); //add hash change listener
      hasher.initialized.add(hashChange); //add initialized listener (to grab initial value in case it is already set)
      hasher.init(); //initialize hasher (start listening for history changes)
    } // END INIT
    
    function changeMap(mapName) {
      if (hasher.getHashAsArray()[1])
        hasher.setHash(mapName, hasher.getHashAsArray()[1]);
      else
        hasher.setHash(mapName);
    }

    function changeGrenadeType(type) {
      if (type)
        hasher.setHash(hasher.getHashAsArray()[0], type);
      else
        hasher.setHash(hasher.getHashAsArray()[0]);
    }
    
    function updateVideo(nade) {
      /*<source src="http://zippy.gfycat.com/WindingInfantileIndianglassfish.webm" type="video/webm">
      <source src="http://zippy.gfycat.com/WindingInfantileIndianglassfish.mp4" type="video/mp4">
      <a href="http://giant.gfycat.com/WindingInfantileIndianglassfish.gif">GIF LINK</a>*/
      /*<video id="gfy" autoplay loop muted="muted" width="100%"></video>*/
      document.getElementById('gfyParent').innerHTML = '' //clear old video

      var vid = document.createElement('video');
      vid.setAttribute('autoplay', 'true');
      vid.setAttribute('loop', 'true');
      vid.setAttribute('muted', 'muted');
      vid.setAttribute('width', '100%');
      if (nade.hasOwnProperty('webm')) {
        var src = document.createElement('source');
        src.setAttribute('src', nade.webm);
        src.setAttribute('type', 'video/webm');
        vid.appendChild(src);
      }
      if (nade.hasOwnProperty('mp4')) {
        var src = document.createElement('source');
        src.setAttribute('src', nade.mp4);
        src.setAttribute('type', 'video/mp4');
        vid.appendChild(src);
      }
      if (nade.hasOwnProperty('gif')) {
        var anc = document.createElement('a');
        anc.setAttribute('href', nade.gif);
        anc.innerHTML = 'GIF Link';
        vid.appendChild(anc);
      }
      document.getElementById('gfyParent').appendChild(vid);
      
      //info
      document.getElementById('iFrom').innerHTML = nade.from;
      document.getElementById('iTo').innerHTML = nade.to;
      document.getElementById('iTeam').innerHTML = nade.team;
      document.getElementById('iSpeed').innerHTML = nade.speed;
      document.getElementById('iHeight').innerHTML = nade.height;
      document.getElementById('iThrow').innerHTML = nade.throw_speed;
    }
    
    function updateMap(mapName) {
      //reset some things
      document.getElementById('mapSelect').value = mapName;
      document.getElementById('nadeList').innerHTML = '';
      
      //check if map exists
      if (!maps.hasOwnProperty(mapName)) {
        if (mapName)
          alert('Invalid map: ' + mapName);
        return false;
      }
      var map = maps[mapName];
      
      s.clear(); //clear the svg

      var scale = map.scale * 1024;
      document.getElementById('map').setAttribute('viewBox', [0, 0, scale, scale].join(' ')); //resize the viewport to scale
    
      
      var image = s.image(map.minimap, 0, 0, scale, scale);
      image.node.onload = function() {
        document.getElementById("map").classList.remove('hide');
      };
      console.log('W/H', scale);
      image.click(function(e, x, y) {
        var box = image.node.getBoundingClientRect();
        var dx = scale * (x - box.left) / (box.right - box.left);
        var dy = scale * (y - box.top) / (box.bottom - box.top);
        console.log(0|dx, 0|dy);
      });
      
      s.group().attr({id: 'nadeGroup'}); //nadegroup after image
      
      if (map.callouts) {
        Snap.load(map.callouts, function (f) {
          s.append(f.select('g').attr({class: 'hide', id: 'callouts'}));

          var callouts = document.getElementById('callouts');
          callouts.parentNode.insertBefore(callouts, document.getElementById('nadeGroup'));
          if (showCallouts)
            document.getElementById('callouts').classList.remove('hide'); //it will probably animate on top of the map's fade in, oh well
        });
      }
      
      return true;
    }

    function updateMapNades(mapName, type) {
      if (!maps.hasOwnProperty(mapName))
        return false;

      var map = maps[mapName];
      if (!map.hasOwnProperty(type)) {
        console.log(type + ' not found for ' + mapName)
        return false;
      }

      var scale = map.scale * 1024;

      var shadow = s.filter(Snap.filter.shadow(0, 0, 20, "#000", 1.0));
      
      var dark = {
        smokes: '#999',
        fires: '#A52',
        flashes: '#5AA'
      }[type];
      var light = "#fff";
      var locMapper = function(n, i) {
        return i % 2 == 0 ? n - map.pos_x : map.pos_y - n;
      };

      for (var i = 0; i < map[type].length; i++) {
        var nade = map[type][i];
        if (nade.loc.length < 2)
          continue;
        var loc = nade.loc.map(locMapper);

        var group = s.group();
        document.getElementById('nadeGroup').appendChild(group.node);

        var thickness = {
          smokes: 32,
          fires: 28,
          flashes: 24
        }[type];

        for (var j = 3; j < loc.length; j += 2) {
          var line = s.line.apply(s, loc.slice(j - 3, j + 1)).attr({
            strokeWidth: thickness,
            fillOpacity: 0,
          });
          group.add(line);
          if (j + 2 < loc.length) {
            var joint = s.circle(loc[j - 1], loc[j], thickness / 2);
            group.add(joint);
          }
        }

        var start = s.circle(loc[0], loc[1], {
          smokes: 60,
          fires: 50,
          flashes: 40
        }[type]);
        var end = s.use().attr('href', 'icons.svg#' + type);
        //end.insertAfter(start);
        end.attr({
          x: loc[loc.length - 2],
          y: loc[loc.length - 1]
        });
        var fakeEnd = s.circle(loc[loc.length - 2], loc[loc.length - 1], 135).attr({ //makes sure smoke unhighlights
          fill: 'transparent',
          stroke: 'transparent'
        });
        //s.circle(loc[loc.length - 2], loc[loc.length - 1], 110);
        
        group.add(start, end, fakeEnd);
        //group.transform('rotate(' + [90 * map.rot, scale / 2, scale / 2].join(' ') + ')');
        
        var enter = function() {
          this.parent().append(this);
          this.attr({
            fill: light,
            stroke: light,
            opacity: 1.0
          });
        }.bind(group);
        var leave = function() {
          this.attr({
            fill: dark,
            stroke: dark,
            opacity: 0.7
          });
        }.bind(group);
        
        group.addClass("arrow").attr({
          fill: dark,
          stroke: dark,
          opacity: 0.5,
          filter: shadow
        }).hover(enter, leave).click(function() {
          hasher.setHash(this.mapName, this.type, this.i);
        }.bind({mapName: mapName, type: type, i: i}));
        
        //add list item
        var li = document.createElement('li')
        li.innerHTML = nade.from + ' to ' + nade.to + ' (' + nade.team + ')';
        li.addEventListener("mouseenter", enter);
        li.addEventListener("mouseleave", leave);
        document.getElementById('nadeList').appendChild(li);
      }
      
      return true;
    }
    
    function toggleCallouts() {
      showCallouts = !showCallouts;
      var button = document.getElementById('toggleCallouts');
      if (!button)
        return;

      if (showCallouts) {
        document.getElementById('callouts').classList.remove('hide');
        button.value = 'Hide Callouts';
      }
      else {
        document.getElementById('callouts').classList.add('hide');
        button.value = 'Show Callouts';
      }
      this.innerHTML = ''
    }
    
  </script>
</body>
</html>
