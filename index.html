<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <title>CSGO Nades</title>
  <meta name="description" content="CSGO Nades">
  <meta name="author" content="Mingwei Samuel">
  
  <!-- Mobile Specific -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
  <![endif]-->
  
  <link href='http://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='http://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css' rel='stylesheet' type='text/css'>
  <link href='./skeleton.custom.min.css' rel='stylesheet' type='text/css'>
  <style type="text/css">
    body {
      font-family: "Exo", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: #000;
    }
    
    p, h1, h2, h3, h4, h5, h6, span, select, li {
      -webkit-filter: invert(100%);
      -moz-filter: invert(100%);
      -ms-filter: invert(100%);
      -o-filter: invert(100%);
      filter: invert(100%);
    }
    
    .section {
      text-align: center;
    }

    .arrow {
      -webkit-transition: all 100ms ease 0s;
      -moz-transition: all 100ms ease 0s;
      -o-transition: all 100ms ease 0s;
      transition: all 100ms ease 0s;
    }
    
    #map {
      -webkit-transition: opacity .5s ease 0s;
      -moz-transition: opacity .5s ease 0s;
      -ms-transition: opacity .5s ease 0s;
      -o-transition: opacity .5s ease 0s;
      transition: opacity .5s ease 0s;
    }
    #map.hide {
      opacity: 0;
    }
    
    #pop {
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
      z-index: 999;
      background-color: rgba(0, 0, 0, 0.8);
    }
    #pop.hide {
      display: none;
    }
    
    img#gfy {
      width: 100%;
    }
  </style>
  
  <script type="text/javascript">
    if (location.href.indexOf('index.html') >= 0)
      location.replace(location.href.replace('index.html', '')); //remove 'index.html', no history entry
  </script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/classlist/2014.01.31/classList.min.js" type="text/javascript"></script>
</head>
<body>
  <div id="pop" class="section hide">
    <div class="container">
      <div class="row">
        <div class="nine column">
          <video id="gfy" autoplay loop muted="muted" poster="//thumbs.gfycat.com/EnergeticExemplaryIlladopsis-poster.jpg" width="100%">
            <source src="//zippy.gfycat.com/EnergeticExemplaryIlladopsis.webm" type="video/webm">
            <source src="//zippy.gfycat.com/EnergeticExemplaryIlladopsis.mp4" type="video/mp4">
            <a href="http://giant.gfycat.com/EnergeticExemplaryIlladopsis.gif">http://giant.gfycat.com/EnergeticExemplaryIlladopsis.gif</a>
          </video>
        </div>
        <div class="three column">
          <p>Info about the gfy</p>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="twelve column">
          <h1>CS:GO Nades</h1>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="nine columns hide">
          <svg id="map">
            <!-- SVG -->
          </svg>
        </div>
        <div class="three columns">
          <div class="row">
            <select class="u-full-width" id="mapSelect" onchange="changeMap(this.value);">
              <option selected disabled hidden value=''>Select Map</option>
              <!-- MAPS SELECT GOES HERE -->
            </select>
          </div>
          <div class="row">
            <h4>Throws:</h4>
            <ul id="nadeList">
              <!-- NADE LIST HERE -->
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script type="text/javascript">
  
    var s = Snap("#map");
    var maps = {};
    var delay = 500;
    
    (function() {
      var xmlhttp;
      if (window.XMLHttpRequest) // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
      else { // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        alert('Please stop using Internet Explorer 5/6 you fakkin joke');
      }
  
      xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
          if(xmlhttp.status == 200){
            maps = JSON.parse(xmlhttp.responseText);
            updateMaps();
            update();
          }
          else {
             alert('Error ' + xmlhttp.status);
          }
        }
      };
  
      xmlhttp.open("GET", "./nades.json", true);
      xmlhttp.send();
    })();
    
    function showVideo(gfy) {
      location.href = 'http://gfycat.com/' + gfy; //does add history entry
    }
    
    function updateMaps() {
      var mapIds = Object.keys(maps);
      for (var i = 0; i < mapIds.length; i++) {
        var opt = document.createElement('option')
        opt.setAttribute('value', mapIds[i]);
        opt.innerHTML = maps[mapIds[i]].name;
        document.getElementById('mapSelect').appendChild(opt);
      }
    }
    
    function changeMap(name) {
      var first = !location.hash.substring(1);
      location.hash = name;
      if (first)
        update();
      else {
        document.getElementById("map").classList.add('hide');
        setTimeout(update, delay);
      }
    }
    
    function update() {
      var mapName = location.hash.substring(1);
      console.log("Updating map to: " + mapName)
      if (!maps.hasOwnProperty(mapName)) {
        if (mapName)
          alert("Invalid map: " + mapName);
        return false;
      }
      document.getElementById('mapSelect').value = mapName;
      document.getElementById('nadeList').innerHTML = '';
      var map = maps[mapName];
      
      s.clear(); //clear the svg
      var scale = map.scale * 1024;
      document.getElementById("map").setAttribute('viewBox', [0, 0, scale, scale].join(' ')); //resize the viewport to scale
    
      
      var image = s.image(map.img, 0, 0, scale, scale);
      image.node.onload = function() {
        document.getElementById("map").classList.remove('hide');
      };
    
      var shadow = s.filter(Snap.filter.shadow(0, 0, 20, "#000", 1.0));
      
      var dark = "#999";
      var light = "#fff";
      var locMapper = function(n, i) {
        return i % 2 == 0 ? n - map.pos_x : map.pos_y - n;
      };
    
      for (var i = 0; i < map.smokes.length; i++) {
        var smoke = map.smokes[i];
        if (smoke.loc.length < 2)
          continue;
        var loc = smoke.loc.map(locMapper);
        
        var polyline = s.polyline(loc).attr({
          strokeWidth: 32,
          fillOpacity: 0,
        });
        var start = s.circle(loc[0], loc[1], 40);
        var end = s.circle(loc[loc.length - 2], loc[loc.length - 1], 110);
        
        var group = s.group(start, polyline, end);
        group.transform('rotate(' + [90 * map.rot, scale / 2, scale / 2].join(' ') + ')');
        
        var enter = function() {
          this.attr({
            fill: light,
            stroke: light,
            opacity: 1.0
          });
        }.bind(group);
        var leave = function() {
          this.attr({
            fill: dark,
            stroke: dark,
            opacity: 0.7
          });
        }.bind(group);
        
        group.addClass("arrow").attr({
          fill: dark,
          stroke: dark,
          opacity: 0.7,
          filter: shadow
        }).hover(enter, leave).click(function() {
          showVideo(this);
        }.bind(smoke.gfy));
        
        //add list item
        var li = document.createElement('li')
        li.innerHTML = smoke.from + ' to ' + smoke.to + ' (' + smoke.team + ')';
        li.addEventListener("mouseenter", enter);
        li.addEventListener("mouseleave", leave);
        document.getElementById('nadeList').appendChild(li);
      }
      
      return true;
    }
  </script>
</body>
</html>
